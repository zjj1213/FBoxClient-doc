## **MQTT的使用配置 （数据转发-固件1400以上使用）**

**在FlexManager软件中使用MQTT协议进行数据转发，主要分为3个步骤：**

**1.连接配置（对接的MQTT服务器参数和MQTT协议参数等）**

**2.数据配置** 

​        **Topic主题及功能配置（主题配置并选择MQTT中的sub、pub的功能项）**

​          **变量关联（从监控点中选择需要的点进行关联）**

 **3.同步配置（发布执行）**



### 1.1新建MQTT连接配置

**在配置连接列表区域中点击图标 “+”，新建MQTT连接配置。**



**如下图 2- 1所示：**

![使用说明](images\tupian3.png)

​                                                                                                                         **图 2- 1**



**将弹出连接配置主界面，如下图 2- 2所示：**

![使用说明](images\tupain4.png)

​                                                                                                                 **图 2- 2**





**主要参数界面中的基本信息说明如下表2- 1：**

| 界面字段 | 描述                                                      | 必填 |
| -------- | --------------------------------------------------------- | ---- |
| 名称     | MQTT连接配置名称，支持32个字符，包括0~9，a~z,汉字等字符。 | √    |
| 代理平台 | 使用提供MQTT服务平台                                      | √    |
| 服务地址 | MQTT推送的服务器地址，支持128个字符                       | √    |
| 服务端口 | MQTT推送的服务器地址的端口号                              | √    |
| 设备ID   | 设备ID是FBox登录MQTT服务器时的客户端标识符                | √    |

​                                                                                                         **表2- 1**



**注：在MQTT功能配置连接列表中最多可新建10个MQTT连接配置，同时只支持一个MQTT连接配置执行，后续版本将支持多个MQTT连接配置执行。**



**常规配置：配置MQTT连接的常规参数，如下图 2- 3所示：**

![使用说明](images\tupian5.png)

​                                                                                                            **图 2- 3**



**界面中的基本信息说明如下表2- 2：**

| 界面字段  | 描述                                                         | 必填 |
| --------- | ------------------------------------------------------------ | ---- |
| MQTT版本  | 目前FlexManager支持，3.1.1和3.1的MQTT标准协议                | √    |
| KeepAlive | 保活时间（Keep Alive）是一个以秒为单位的时间间隔，为一个16位的字，它是指在客户端传输完成一个控制报文的时刻到发送下一个报文的时刻，两者之间允许空闲的最大时间间隔 | √    |
| 上传方式  | 设置数据上传推送方式，支持周期推送和变化推送                 | √    |
| 周期      | 设置数据周期推送时间                                         | √    |

​                                                                                                           **表2- 2**





**用户验证：配置MQTT登录服务器的验证信息，如下图 2- 4所示：**

![使用说明](images\tupain6.png)

​          

​                                                                                                               **图 2- 4**



**用户验证界面中的基本信息说明如下表2- 3：**

| 界面字段 | 描述                                     | 必填 |
| -------- | ---------------------------------------- | ---- |
| 用户验证 | 是FBox登录MQTT服务器所需要的用户信息验证 | √    |
| 用户名   | 登录MQTT服务器用户名                     | √    |
| 密码     | 登录MQTT服务器密码                       | √    |



**连接模式：配置MQTT登录服务器的验证信息，如下图 2- 5所示：**

![使用说明](images\tupian7.png)

​                                                               

​                                                                                                                **图 2- 5**

  

**连接模式界面中的基本信息说明如下表2- 4：**

| 界面字段   | 描述                                                         | 必填 |
| ---------- | ------------------------------------------------------------ | ---- |
| 连接方式   | TCP的MQTT连接，并提供了两种连接方式：TCP连接、TCP加密连接(与MQTT服务器使用TLS（SSL）进行通讯) | √    |
| 客户端证书 | 客户端证书文件                                               |      |
| CA证书     | 根证书，单击[ca.crt](https://main.qcloudimg.com/raw/9aa774ea8c09f98811df361c741df38c/ca.crt)链接下载文件。 |      |
| 客户端密钥 | 客户端密钥文件                                               |      |

​                                                                                                                     **表2- 4**







**其他配置：配置MQTT登录服务器的验证信息，如下图 2- 6所示：**

![使用说明](images\tupian8.png)

​                                                                                                        **图 2- 6**



**其他配置界面中的基本信息说明如下表2- 5：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | ------------------------------------------------------------ | ---- |
| 离线缓存 | 允许在MQTT离线的状态下，将推送的消息缓存到SD卡U盘或本地，当FBox重新上线后会将缓存数据重新上传 | √    |
| 存储方式 | 存储到本地最大存储条数为1000条，SD卡和U盘根据容量大小不同来判断数据存储量。说明：本地保存数据最大1000条，超过1000条时会自动覆盖前面数据 |      |

​                                                                                                                  **表2- 5** 



### 1.2 数据配置

在 数据配置列表 区域中点击“添加”按钮，添加MQTT数据配置。如下图 2- 7：

![使用说明](images\tupian9.png)

​                                                                                                                  **图 2-7**



#### *1.2.1主题及功能配置*

**将弹出MQTT数据配置的界面，我们用Pub操作权限下的发布监控点数据来做一个示范，如下图 2- 8所示：**

![使用说明](images\tupian10.png)

​                                                                                                                 **图 2- 8**



**界面中的基本信息说明如下表2- 6：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | :----------------------------------------------------------- | ---- |
| 主题     | 主题(Topic)是UTF-8字符串，是发布/订阅（Pub/Sub）消息的传输中介，MQTT是通过主题对消息进行分类。注：主题名称可自定义配置(与MQTT服务器中的主题相匹配)，但在同一配置协议中不支持配置相同的主题信息，一个主题只能对应一个功能 | √    |
| 描述     | 当前数据配置的描述信息                                       |      |
| 操作权限 | sub表示需要订阅的主题，pub表示需要发布的主题，pub_sub表示该主题既可以订阅也可以发布 | √    |
| 功能     | 为当前FlexManager软件通过MQTT所支持的功能，功能详情接收请查看[功能描述](Features.md) | √    |

​                                                                                                               **表2- 6**



#### 1.2.2 MQTT数据关联

   **1. 如需自定义JSON数据层级，选择“添加“。**

![使用说明](images\tupian11.png)



**点击“添加”按钮，表格中新增一条MQTT变量数据。**

**当属性类型选择int,long,uint,float,double,string,boolean时，需要点击![](images\tupian44.png)关联变量按钮，选择关联某一个内部变量或者监控点。**

**当属性类型中选择array或者object时，可以选择![](images\tupian45.png)添加子项或者![](images\tupian46.png)批量导入监控点。如下图 2- 8所示：**

![使用说明](images\tupian12.png)

![使用说明](images\tupian13.png)

​                                                                                                                     **图 2- 8** 



**界面中的基本信息说明如下表2- 6：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | ------------------------------------------------------------ | ---- |
| MQTT变量 | 可自定义MQTT变量名称，与服务器名称保持一致                   | √    |
| 熟悉类型 | 变量数据支持多种类型。注意：选择“array”、“obiect”时，可执行添加子项、批量导入功能，不能执行关联 | √    |
| 变量名称 | 关联数据的变量名称。注意：同一层级中，变量名称不允许相同     |      |
| 删除     | 删除选择的数据条目                                           |      |
| 关联     | 关联变量。注意：只有选择非“array”、“obiect”时，才能关联      |      |
| 添加子项 | 在当前数据条目下级，添加子项MQTT变量                         |      |
| 批量导入 | 在当前数据条目下级，批量关联变量                             |      |

​                                                                                                                     **表2- 6**



**2. 如需快速导入监控点，选择“批量导入”。**

**选择批量导入后，会弹窗出现关联变量界面。如下图 2- 9所示：**

![使用说明](images\tupian14.png)

​                                                                                                                     **图 2- 9**



**界面中的基本信息说明如下表2- 7：**

| 界面字段             | 描述                                                         | 必填 |
| -------------------- | ------------------------------------------------------------ | ---- |
| 内部变量             | FBox当前支持MQTT执行的内部功能变量。详情可查看内部变量[参数规范](specification.md) |      |
| 监控点               | 监控点变量数据                                               |      |
| 名称                 | 内部变量名称                                                 |      |
| 数据类型             | 内部变量数据类型                                             |      |
| 描述                 | 当前变量数据的描述信息                                       |      |
| 默认生成MQTT变量名称 | 勾选此功能点击“确认”按钮，可将关联变量名称的自动生成到MQTT变量名称中，替换原来的MQTT变量名称 |      |

​                                                                                                                     **表2- 7**



**点击“监控点”按钮，会切换到监控点变量页中，如下图 2- 10所示：**

![使用说明](images\tupian15.png)

​                                                                                                                     **图 2- 10** 



**界面中的基本信息说明如下表2- 8：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | ------------------------------------------------------------ | ---- |
| 名称     | 监控点名称。注：监控点名称只能在“监控点”管理页面修改         |      |
| 数据类型 | 监控点数据类型。注：监控点数据类型只能在“监控点”管理页面修改 |      |
| 读写类型 | 监控点的类型                                                 |      |
| 描述     | 当前监控点数据的描述信息                                     |      |
| 组合方式 | JSON KV 和JSON NV 是两种点位上报类型，用来适配不同格式的上报方式；其中，KV表示{“temprature”:37}这种Json格式类型， NV 表示{“name”:”temprature”,”value”:37}这种数据格式类型； |      |

​                                                                                                                       **表2- 8**



### 1.3 配置同步

**配置完成保存之后在“数据配置列表”页点击“配置同步”按钮，将已配置的数据下发到FBox中进行执行，如下所示：**

![使用说明](images\tupian16.png)

​                                                                                                                          

​                                                                                                                      **图 2- 11** 



**界面中的基本信息说明如下表2- 9：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | ------------------------------------------------------------ | ---- |
| 添加     | 添加多条MQTT主题功能数据。说明：同一主题(Topic)只能配置一个功能 |      |
| 配置同步 | 将当前MQTT连接配置文件（包含主题功能数据）打包下发到FBox中进行执行 |      |
| 导入配置 | 可以将其他FBox中的MQTT连接配置文件，导入至当前连接配置列表中。说明：导入文件和当前FBox中的监控点不一致时，会自动去掉不一致的MQTT变量数据 |      |
| 导出配置 | 当前MQTT连接配置文件（包含主题功能数据）打包生成.cfg格式导出，方便查看连接配置数据格式 |      |
| 批量删除 | 多选批量删除数据配置列表数据                                 |      |
| 搜索     | 可搜索“主题”“描述”字段                                       |      |

​                                                                                                                      **表2- 9**



### 1.4 配置连接列表

**在“配置连接列表”区域中页点击![](E:\FBoxClient-doc\employ\images\tupian17.png)按钮，可对当前MQTT连接配置文件进行操作，如下图 2- 12所示：**

![使用说明](images\tupian18.png)

​                                                                                                                        **图 2- 12**



**界面中的基本信息说明如下表2- 10：**

| 界面字段 | 描述                                                         | 必填 |
| -------- | ------------------------------------------------------------ | ---- |
| 图标     | 当前配置连接的状态。说明：灰色表示未执行，绿色表示已下发执行 |      |
| 名称     | 当前配置连接名称。说明：在当前配置连接列表中，不允许存在相同的名称 |      |
| 编辑     | 对当前配置连接进行修改                                       |      |
| 复制     | 可将当前MQTT配置连接数据（包含主题功能数据）复制给当前FBox和客户拥有的其他FBox。说明：复制给其他FBox时，一次最多只能复制给10个FBox |      |
| 删除     | 删除当前MQTT配置连接数据（包含主题功能数据）                 |      |

​                                                                                                                      **表2- 10**